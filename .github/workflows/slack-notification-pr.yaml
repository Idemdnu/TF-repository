name: Notify Slack on PR merge

on:
  pull_request:
    types: [closed]
    branches: [ main ]

jobs:
  notify-slack:
    runs-on: ubuntu-latest
    # Only run if the PR was actually merged (not just closed)
    if: github.event.pull_request.merged == true

    steps:
      - name: Send Slack notification
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
          PR_TITLE: ${{ github.event.pull_request.title }}
          PR_URL: ${{ github.event.pull_request.html_url }}
          PR_AUTHOR: ${{ github.event.pull_request.user.login }}
          MERGED_BY: ${{ github.event.pull_request.merged_by.login }}
        run: |
          payload=$(cat <<EOF
          {
            "text": ":white_check_mark: *PR merged!*",
            "blocks": [
              {
                "type": "section",
                "text": {
                  "type": "mrkdwn",
                  "text": ":white_check_mark: *PR merged into* \`main\`:\n*Title:* ${PR_TITLE}\n*Author:* ${PR_AUTHOR}\n*Merged by:* ${MERGED_BY}\n*Link:* ${PR_URL}"
                }
              }
            ]
          }
          EOF
          )

          curl -X POST -H "Content-type: application/json" \
            --data "${payload}" \
            "$SLACK_WEBHOOK_URL"
